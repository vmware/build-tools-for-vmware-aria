# v2.24.0

This version is a maintenance release that comes with various improvements to different components of the toolchain and 
its archetypes. There is a new breaking change introduced in this release, so please read the upgrade procedures carefully
before updating.

## **Breaking Changes**

### `content.yaml` Filtering has been changed for vRA 8.x archetypes
The breaking change affects ONLY the vRA 8.x ( vra-ng ) archetype.

Read more about the change [here](#improved-filtering-in-contentyaml-for-vra-8x-projects).

Read the upgrade procedure [here](#contentyaml-modifications-for-vra-8x-projects).

## Deprecations

### Deprecation:
*NONE*


## Features

### *Enable coverage level per file*
Code coverage per file bases. Set custom --coverage-thresholds, if any file in the project drops below those thresholds, the build will fail

Enable by setting `<test.coverage.perfile>true</test.coverage.perfile>` in your `~/.m2/settings.xml` testing profile.

Refer to InstanbulJS documentation for more information: https://github.com/istanbuljs/nyc

### *Exclude files from Test Code Coverage/Defining Test Helpers*
A new extension has been added to typescript projects `*.helper.[tj]s`. If you define an action with this extension, then
this action will not be included in the code coverage report generated by the toolchain.

Defining a Test Helper also means that this action will **NOT** be pushed to vRO.

#### Example:
`test.helper.ts`:
~~~typescript
export default function (){
    return Math.random();
}
~~~
`example.ts`:
~~~typescript
import testHelper from "./test.helper";

export default function () {
    return testHelper();
}
~~~

#### Relevant Documentation:
* [Code Coverage](./Components/Archetypes/typescript/General/Testing/Code%20Coverage.md)
* [Test Helpers](./Components/Local/Typescript/vrotsc/Components/Test%20Helpers.md)
* [How vrotest works](./Components/Local/Typescript/vrotest/General/How%20Does%20It%20Work.md)

### Code Stream Support for Triggers (webhooks)
Provide the ability of code stream project to handle last piece of configuration content: Triggers.

#### Order of import
Should be imported last as they are depended on endpoints, variables and pipelines)

#### Order of export 
Should be extracted before variables to be able to register its variables into the variable extraction step (see pipeline and endpoint extraction).

#### Added:
* Git webhooks
* Docker webhooks
* Gerrit triggers

Code Stream project `content.yaml`:
~~~yaml
pipeline:
  - Pipeline Name
endpoint:
  - Endpoint Name
custom-integration:
  - Custom Integration Name
variable:
  - Variable name
  
# NEWLY ADDED:
git-webhook:
docker-webhook:
gerrit-listener:
gerrit-trigger:
# END OF NEWLY ADDED:
~~~

#### Relevant Documentation:
*NONE*

## Improvements:

### *Fixed an issue when pushing custom resource with additional actions*
When pushing custom resource with additional actions, the push of actions was failing and the custom resource was 
created without additional actions.

#### Previous Behavior
When pulling a Custom Resource with Day-2 Actions it would fail with 
```log
[ERROR] Failed to execute goal com.vmware.pscoe.maven.plugins:vrealize-package-maven-plugin:2.22.2:push (default-cli)
on project vcfLBResource: Execution default-cli of goal com.vmware.pscoe.maven.plugins:vrealize-package-maven-plugin:2.22.2:push 
failed: Could not import custom resource with name 'vcfLoadBalancerInstance' : 400 Bad Request 
{"timestamp":"2022-05-11T11:53:03.233+0000","path":"/form-service/api/custom/resource-types","status":400,"error":
"Bad Request","message":"400 BAD_REQUEST \"Custom resource with the same external type and scope already exists. Use 
a different external type.\"","requestId":"8fc990b3-10","@type":"org.springframework.web.server.ResponseStatusException"}
```

#### Current Behavior
The issue is fixed and additional actions are correctly imported.

### *Fixed whitespaces in path leading vrotest to an error*
Ensure all paths passed in the command line are enclosed by double quotes.

#### Previous Behavior
When using --instrument mode under Windows and if the path contains space(s), running of vrotest fails.

#### Current Behavior
Spaces in path are now supported

#### Relevant Documentation:
*NONE*

### *Custom Resource creation when resource is in use*
Skip import of a custom resource if it has deployments without failing the overall import.

#### Previous Behavior
When a custom resource has deployments, its deletion fails. The error is logged as warning and ignored:
~~~log
[WARNING] Cannot import Custom Resource 'Sdk Connection', due to active attachments. Original Error Message: 400 Bad Request {"timestamp":"2022-05-11T09:11:43.815+0000","path":"/form-service/api/custom/resource-types/362340c0-f266-4dc8-96e6-92582401e638","status":400,"error":"Bad Request","message":"400 BAD_REQUEST \"Resource type cannot be deleted as there are active resources attached to it: 'Custom.SDKCONN'\"","requestId":"63105cae-182336","@type":"org.springframework.web.server.ResponseStatusException"}
~~~
Process continues with importing the updated resource, fails (resource was not deleted), and fails the entire build.
~~~log
[ERROR] Failed to execute goal com.vmware.pscoe.maven.plugins:vrealize-package-maven-plugin:2.23.1-SNAPSHOT:push (default-cli) on project filteringcontent: Execution default-cli of goal com.vmware.pscoe.maven.plugins:vrealize-package-maven-plugin:2.23.1-SNAPSHOT:push failed: Could not import custom resource with name 'Sdk Connection' : 400 Bad Request {"timestamp":"2022-05-11T09:11:43.853+0000","path":"/form-service/api/custom/resource-types","status":400,"error":"Bad Request","message":"400 BAD_REQUEST \"Custom resource with the same external type and scope already exists. Use a different external type.\"","requestId":"63105cae-182337","@type":"org.springframework.web.server.ResponseStatusException"}
~~~

#### Current Behavior
In case of the above error, the import of the custom resource is aborted and the build continues with the next item. The current WARNING is logged on DEBUG level and a new user-friendlier ERROR is logged.
~~~log
[DEBUG] Cannot delete Custom Resource 'Sdk Connection', due to active deployments. Original Error Message: 400 Bad Request {"timestamp":"2022-05-11T11:56:26.685+0000","path":"/form-service/api/custom/resource-types/362340c0-f266-4dc8-96e6-92582401e638","status":400,"error":"Bad Request","message":"400 BAD_REQUEST \"Resource type cannot be deleted as there are active resources attached to it: 'Custom.SDKCONN'\"","requestId":"7933b742-184700","@type":"org.springframework.web.server.ResponseStatusException"}
[ERROR] Failed to update Custom Resource 'Sdk Connection'. Could not delete the existing custom resource due to active deployments. Creating updated custom resource was skipped.
~~~

#### Relevant Documentation:
*NONE*

### *Remove SSL TLS v 1.3 support in the installer*
Due to JDK bug JDK-8221253 the SSL v 1.3 support is removed from the list of supported SSL algorithms.

### *Updated storage format for property groups and removed unnecessary fields*
The Property Groups raw data is now sanitized

#### Previous Behavior
Currently, property groups are extracted as 3 properties
* id
* name
* raw data : stringified json

The raw data is not cleaned on export and not updated on import in any way. Which may lead to errors like
* the org_id is not cleansed: may or may not be taken into account during import
* Scope: project_id and name are not cleaned and not updated during import: it does not respect the configured project
  in env.properties or settings.xml.
* The stringified json is not workable in any way.
* The create/update of the property group is forced ( post-error-update ) which is not good

#### Current Behavior
The raw data is now sanitized before exporting. Removed properties:
1. `orgId`
2. `projectId`
3. `projectName`
4. `id`
5. `createdAt`
6. `createdBy`
7. `updatedAt`
8. `updatedBy`

#### Relevant Documentation:
*NONE*


### *Fixed typos/naming in interactive installer*
During the interactive installer, some of the prompts had typos or were not explained well. We've gone through them and 
they have been fixed.

There were a lot of minor naming inconsistencies and they have all been resolved.

Overall this Improvement is purely cosmetic.

#### Relevant Documentation:
*NONE*

### *Improved Filtering in `content.yaml` for vRA 8.x Projects*
vRA 8.X Projects have a `content.yaml` file that describes the vRA content we will be working with. 
Example `content.yaml` is described below:
~~~yaml
blueprint:
subscription:
flavor-mapping:
image-mapping:
storage-profile:
region-mapping:
  cloud-account-tags:
    export-tag: "env:dev"
    import-tags: ["env:dev", "env:test"]
custom-resource:
resource-action:
catalog-entitlement:
catalog-item:
content-sources:
~~~
This improvement aims to unify how content is pulled.

#### Previous Behavior
Before the content to pull would be filtered by different rules depending on the type of element.
For example: 

1. `blueprint` -> Fetch ONLY blueprints defined in the yaml
2. `subscription` -> Fetch ONLY subscriptions defined in the yaml
3. `flavor-mapping` -> Fetch ONLY flavor-mapping defined in the yaml
4. `image-mapping` -> Fetch ONLY image-mapping defined in the yaml
5. `storage-profile` -> Fetch ONLY storage-profile defined in the yaml
6. `custom-resource` -> Fetch ONLY custom-resource defined in the yaml
7. `catalog-entitlement` -> Fetch ALL catalog-entitlement if nothing is defined, otherwise fetch by filter
8. `catalog-item` -> Fetch ALL catalog-item if nothing is defined, otherwise fetch by filter
9. `content-sources` -> Fetch ALL content-sources if nothing is defined, otherwise fetch by filter
10. `property-group` -> Fetch ALL property-group if nothing is defined, otherwise fetch by filter

#### New Behavior
**ALL** of the elements are filtered by these rules:

1. If nothing is defined, **everything** will be pulled.
2. If an empty array is defined, **nothing** will be pulled
3. If a non-empty array is defined, **only** what is defined in the array will be pulled

Example:
~~~yaml
blueprint: # Fetch everything
subscription: # Fetch everything
flavor-mapping: [] # Fetch nothing
image-mapping: [] # Fetch nothing
storage-profile: [] # Fetch nothing
region-mapping:
  cloud-account-tags:
    export-tag: "env:dev"
    import-tags: ["env:dev", "env:test"]
custom-resource:
  - Custom Resource # Fetch ONLY `Custom Resource`
resource-action: [] # Fetch nothing
catalog-entitlement: [] # Fetch nothing
catalog-item: [] # Fetch nothing
content-sources: [] # Fetch nothing
property-group: [] # Fetch nothing
~~~

#### Relevant Documentation:
1. [Content](./Components/Archetypes/vRA%208.x/General/Content.md)

## Upgrade procedure:

### `content.yaml` modifications for vRA 8.x projects
Read more about this improvement [here](#improved-filtering-in-contentyaml-for-vra-8x-projects)

Check your `content.yaml` file and apply the required changes. Consult the improvement on what was changed as the rules 
are defined there

For example, some modifications:
Before:
~~~yaml
blueprint:
content-sources:
catalog-item: 
  - SOURCE__CatalogItem
~~~

After:
~~~yaml
blueprint: [] # Previously we wanted to fetch nothing
content-sources: # Previously we wanted to fetch everything 
catalog-item: # Previously we had a filter
  - SOURCE__CatalogItem
~~~
